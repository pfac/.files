#!/bin/sh
# Configure the system with pfac's preferences.
set -e

# Set default values
BRANCH=master
CLONE_TO="$HOME/Developer/pfac/.files"
SUDO=''

# Detect system
SYSTEM="$(uname)"
case "$SYSTEM" in
  Linux)
    SYSTEM="$SYSTEM:$(cat /etc/lsb-release | grep DISTRIB_ID | cut -d= -f2)"
esac

# Detect privileges
[ "$(whoami)" != 'root' ] && SUDO='sudo'

# Process options
while getopts 'b:' option; do
  case "$option" in
    b)
      BRANCH="$OPTARG"
      ;;
    ?)
      echo "Unknown option $option" >&2
  esac
done

# Ensuring a package manager is available to install dependencies
case "$SYSTEM" in
  Darwin)
    if ! command -v brew >/dev/null; then
      echo '==> Installing HomeBrew'
      /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
      echo '\o/ HomeBrew installed'
    else
      echo '--- Homebrew already installed'
    fi
    ;;
  Linux:Ubuntu)
    if command -v apt-get >/dev/null; then
      echo '==> Updating APT cache (sudo required)'
      $SUDO apt-get update
    else
      echo 'Ubuntu system is expected to have the APT package manager. Aborting' >&2
      exit 3
    fi
    ;;
  *)
    echo "Current system '$SYSTEM' is not supported. Aborting" >&2
    exit 2
esac

# Ensure Ansible is installed in the system.
if ! command -v ansible >/dev/null; then
  echo '==> Dependency missing: ansible'
  MISSING_DEPS="$MISSING_DEPS ansible"
else
  echo "--- Ansible found: $(command -v ansible)"
fi

# Ensure Git is installed in the system.
if ! command -v git >/dev/null; then
  echo '==> Dependency missing: git'
  MISSING_DEPS="$MISSING_DEPS git"
else
  echo "--- Git found: $(command -v git)"
fi

# Ensure missing dependencies are installed in the system
if [ "$MISSING_DEPS" ]; then
  case "$SYSTEM" in
    Darwin)
      echo '==> Installing missing dependencies through HomeBrew'
      brew install $MISSING_DEPS
      echo "\o/ $MISSING_DEPS installed"
      ;;
    Linux:Ubuntu)
      echo '==> Installing missing dependencies through APT (sudo required)'
      $SUDO apt-get install -y $MISSING_DEPS
      ;;
    *)
      echo "Current system '$SYSTEM' is not supported. Aborting" >&2
      exit 2
  esac
else
  echo '--- No dependencies missing'
fi

# Clone repository into the system.
if ! [ -d "$CLONE_TO/.git" ]; then
  echo "==> Cloning $BRANCH branch to $CLONE_TO"
  git clone -b "$BRANCH" https://github.com/pfac/.files "$CLONE_TO"
  echo '\o/ Repository cloned'
else
  echo "--- Repository present in $CLONE_TO"
  cd "$CLONE_TO"
  if ! [ "$(git rev-parse --abbrev-ref HEAD)" = "$BRANCH" ]; then
    echo "==> Checking out $BRANCH branch"
    git checkout "$BRANCH"
    echo '\o/ Branch checked out'
  else
    echo "--- Branch $BRANCH already checked out"
  fi
fi

# Hand-over installation to Ansible
"$CLONE_TO/bin/provision" -d "$CLONE_TO"

# Success
cat <<EOS
================================================================================

pfac's home installed successfully \o/

To change something, simply edit the Ansible playbook for the current system and
run $CLONE_TO/bin/provision again.
EOS
